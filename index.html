<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beta Hedge Multi-Paires Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    
    <script>
        const Icons = {
            Calculator: () => `<svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>`,
            BarChart: () => `<svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`,
            Download: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`,
            Plus: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>`,
            X: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
            AlertCircle: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };

        const CRYPTO_PAIRS = {
            'aave': { name: 'AAVE', id: 'aave' },
            'cardano': { name: 'ADA', id: 'cardano' },
            'aerodrome-finance': { name: 'AERO', id: 'aerodrome-finance' },
            'ai16z': { name: 'AI16Z', id: 'ai16z' },
            'algorand': { name: 'ALGO', id: 'algorand' },
            'aptos': { name: 'APT', id: 'aptos' },
            'apex-protocol': { name: 'APEX', id: 'apex-protocol' },
            'arbitrum': { name: 'ARB', id: 'arbitrum' },
            'astar': { name: 'ASTR', id: 'astar' },
            'avalanche-2': { name: 'AVAX', id: 'avalanche-2' },
            'avantis': { name: 'AVNT', id: 'avantis' }, // Corrig√© de 'avant'
            'axie-infinity': { name: 'AXS', id: 'axie-infinity' },
            'basic-attention-token': { name: 'BAT', id: 'basic-attention-token' },
            'berachain-bera': { name: 'BERA', id: 'berachain-bera' },
            'binancecoin': { name: 'BNB', id: 'binancecoin' },
            'bonk': { name: 'BONK', id: 'bonk' },
            'bitcoin': { name: 'BTC', id: 'bitcoin' },
            'pancakeswap-token': { name: 'CAKE', id: 'pancakeswap-token' },
            'curve-dao-token': { name: 'CRV', id: 'curve-dao-token' },
            'dash': { name: 'DASH', id: 'dash' },
            'dogecoin': { name: 'DOGE', id: 'dogecoin' },
            'polkadot': { name: 'DOT', id: 'polkadot' },
            'dydx-chain': { name: 'DYDX', id: 'dydx-chain' },
            'eigenlayer': { name: 'EIGEN', id: 'eigenlayer' },
            'ethena': { name: 'ENA', id: 'ethena' },
            'eos': { name: 'EOS', id: 'eos' },
            'ethereum': { name: 'ETH', id: 'ethereum' },
            'ether-fi': { name: 'ETHFI', id: 'ether-fi' },
            'fartcoin': { name: 'FARTCOIN', id: 'fartcoin' },
            'fetch-ai': { name: 'FET', id: 'fetch-ai' },
            'filecoin': { name: 'FIL', id: 'filecoin' },
            'flow': { name: 'FLOW', id: 'flow' },
            'fantom': { name: 'FTM', id: 'fantom' },
            'gala': { name: 'GALA', id: 'gala' },
            'goatseus-maximus': { name: 'GOAT', id: 'goatseus-maximus' },
            'grass': { name: 'GRASS', id: 'grass' },
            'the-graph': { name: 'GRT', id: 'the-graph' },
            'helium': { name: 'HNT', id: 'helium' },
            'hyperliquid': { name: 'HYPE', id: 'hyperliquid' },
            'internet-computer': { name: 'ICP', id: 'internet-computer' },
            'immutable-x': { name: 'IMX', id: 'immutable-x' },
            'injective-protocol': { name: 'INJ', id: 'injective-protocol' },
            'story': { name: 'IP', id: 'story' }, // Corrig√© de 'story-2'
            'jupiter-exchange-solana': { name: 'JUP', id: 'jupiter-exchange-solana' },
            'kaito': { name: 'KAITO', id: 'kaito' },
            'lido-dao': { name: 'LDO', id: 'lido-dao' },
            'linea': { name: 'LINEA', id: 'linea' },
            'chainlink': { name: 'LINK', id: 'chainlink' },
            'litecoin': { name: 'LTC', id: 'litecoin' },
            'decentraland': { name: 'MANA', id: 'decentraland' },
            'maker': { name: 'MKR', id: 'maker' },
            'mantle': { name: 'MNT', id: 'mantle' },
            'moo-deng': { name: 'MOODENG', id: 'moo-deng' },
            'monster': { name: 'MON', id: 'monster' },
            'near': { name: 'NEAR', id: 'near' },
            'mantra-dao': { name: 'OM', id: 'mantra-dao' },
            'ondo-finance': { name: 'ONDO', id: 'ondo-finance' },
            'optimism': { name: 'OP', id: 'optimism' },
            'ordinals': { name: 'ORDI', id: 'ordinals' },
            'osmosis': { name: 'OSMO', id: 'osmosis' },
            'pendle': { name: 'PENDLE', id: 'pendle' },
            'pudgy-penguins': { name: 'PENGU', id: 'pudgy-penguins' },
            'pepe': { name: 'PEPE', id: 'pepe' },
            'polygon-ecosystem-token': { name: 'POL', id: 'polygon-ecosystem-token' },
            'popcat': { name: 'POPCAT', id: 'popcat' },
            'pyth-network': { name: 'PYTH', id: 'pyth-network' },
            'render-token': { name: 'RNDR', id: 'render-token' },
            'resolv': { name: 'RESOLV', id: 'resolv' },
            'thorchain': { name: 'RUNE', id: 'thorchain' },
            'bitcoin-cash-sv': { name: 'BSV', id: 'bitcoin-cash-sv' }, // Corrig√© le nom de 'S' √† 'BSV'
            'the-sandbox': { name: 'SAND', id: 'the-sandbox' },
            'sei-network': { name: 'SEI', id: 'sei-network' },
            'shiba-inu': { name: 'SHIB', id: 'shiba-inu' },
            'synthetix-network-token': { name: 'SNX', id: 'synthetix-network-token' },
            'solana': { name: 'SOL', id: 'solana' },
            'spx6900': { name: 'SPX', id: 'spx6900' },
            'starknet': { name: 'STRK', id: 'starknet' },
            'sui': { name: 'SUI', id: 'sui' },
            'bittensor': { name: 'TAO', id: 'bittensor' },
            'theta-token': { name: 'THETA', id: 'theta-token' },
            'celestia': { name: 'TIA', id: 'celestia' },
            'the-open-network': { name: 'TON', id: 'the-open-network' },
            'official-trump': { name: 'TRUMP', id: 'official-trump' },
            'tron': { name: 'TRX', id: 'tron' },
            'uniswap': { name: 'UNI', id: 'uniswap' },
            'usual': { name: 'USUAL', id: 'usual' },
            'virtuals-protocol': { name: 'VIRTUAL', id: 'virtuals-protocol' },
            'dogwifcoin': { name: 'WIF', id: 'dogwifcoin' },
            'worldcoin-wld': { name: 'WLD', id: 'worldcoin-wld' },
            'world-liberty-financial': { name: 'WLFI', id: 'world-liberty-financial' },
            'stellar': { name: 'XLM', id: 'stellar' },
            'monero': { name: 'XMR', id: 'monero' },
            'xai-blockchain': { name: 'XAI', id: 'xai-blockchain' }, // Corrig√© de XPL
            'ripple': { name: 'XRP', id: 'ripple' },
            'zcash': { name: 'ZEC', id: 'zcash' },
            'zora': { name: 'ZORA', id: 'zora' },
            'layerzero': { name: 'ZRO', id: 'layerzero' }
        };

        class BetaHedgeCalculator {
            constructor() {
                this.state = {
                    activeTab: 'calculator',
                    assets: [
                        { id: 'ethereum', name: 'ETH', data: '', volatility: 0, selected: 'ethereum' },
                        { id: 'solana', name: 'SOL', data: '', volatility: 0, selected: 'solana' }
                    ],
                    betaResults: null,
                    period: 30,
                    capital: 10000,
                    leverage: 1,
                    loading: false,
                    progressMessage: ''
                };
                this.init();
            }

            init() {
                this.render();
                this.attachEvents();
            }

            addAsset() {
                if (this.state.assets.length >= 10) {
                    alert('Maximum 10 assets');
                    return;
                }
                this.state.assets.push({
                    id: `asset_${Date.now()}`,
                    name: 'BTC',
                    data: '',
                    volatility: 0,
                    selected: 'bitcoin'
                });
                this.render();
                setTimeout(() => {
                    const newIndex = this.state.assets.length - 1;
                    const select = document.getElementById(`asset-select-${newIndex}`);
                    if (select) select.value = 'bitcoin';
                }, 50);
            }

            removeAsset(index) {
                if (this.state.assets.length <= 2) {
                    alert('Minimum 2 assets requis');
                    return;
                }
                this.state.assets.splice(index, 1);
                this.render();
            }

            async fetchCryptoData(coinId, days, retries = 3) {
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        const url = `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart`;
                        const params = new URLSearchParams({
                            vs_currency: 'usd',
                            days: days.toString(),
                            interval: 'daily'
                        });
                        const response = await fetch(`${url}?${params}`);
                        
                        // Si rate limited (429), attendre plus longtemps
                        if (response.status === 429) {
                            const waitTime = (attempt + 1) * 5000; // 5s, 10s, 15s
                            console.log(`‚è≥ Rate limited. Attente ${waitTime/1000}s avant retry...`);
                            this.state.progressMessage = `‚è≥ API limit√©e, attente ${waitTime/1000}s...`;
                            this.render();
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            continue;
                        }
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`API error (${response.status}): ${errorText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.prices || data.prices.length === 0) {
                            throw new Error('Aucune donn√©e de prix disponible');
                        }
                        
                        return data.prices.map(p => p[1]);
                    } catch (error) {
                        if (attempt === retries - 1) {
                            console.error(`‚ùå Erreur pour ${coinId} apr√®s ${retries} tentatives:`, error);
                            throw error;
                        }
                        // Attendre avant de r√©essayer
                        console.log(`‚ö†Ô∏è Tentative ${attempt + 1}/${retries} √©chou√©e, retry...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }

            async fetchAllAssets() {
                this.state.loading = true;
                this.state.progressMessage = 'D√©marrage...';
                this.render();
                
                const successfulAssets = [];
                const failedAssets = [];
                const REQUEST_DELAY = 6000; // 6 secondes entre chaque requ√™te
                const SUPER_PAUSE_EVERY = 4; // Faire une super pause tous les 4 assets
                const SUPER_PAUSE_DELAY = 30000; // 30 secondes de super pause
                
                try {
                    for (let i = 0; i < this.state.assets.length; i++) {
                        const asset = this.state.assets[i];
                        const coinData = CRYPTO_PAIRS[asset.selected];
                        
                        try {
                            this.state.progressMessage = `Asset ${i + 1}/${this.state.assets.length}: ${coinData.name}...`;
                            this.render();
                            
                            console.log(`üì° [${i+1}/${this.state.assets.length}] R√©cup√©ration de ${coinData.name} (${coinData.id})...`);
                            const data = await this.fetchCryptoData(coinData.id, this.state.period);
                            
                            asset.data = data.map(p => p.toFixed(4)).join('\n');
                            asset.name = coinData.name;
                            successfulAssets.push(coinData.name);
                            
                            console.log(`‚úÖ ${coinData.name} OK (${data.length} prix)`);
                            
                            // Gestion intelligente des pauses
                            if (i < this.state.assets.length - 1) {
                                // Tous les 4 assets, faire une SUPER PAUSE
                                if ((i + 1) % SUPER_PAUSE_EVERY === 0) {
                                    this.state.progressMessage = `‚úÖ ${coinData.name} OK | üîÑ SUPER PAUSE ${SUPER_PAUSE_DELAY/1000}s (reset rate limit)...`;
                                    this.render();
                                    console.log(`üîÑ SUPER PAUSE apr√®s ${i+1} assets (${SUPER_PAUSE_DELAY/1000}s)...`);
                                    await new Promise(resolve => setTimeout(resolve, SUPER_PAUSE_DELAY));
                                } else {
                                    // Pause normale entre requ√™tes
                                    this.state.progressMessage = `‚úÖ ${coinData.name} OK | Pause ${REQUEST_DELAY/1000}s...`;
                                    this.render();
                                    await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
                                }
                            }
                            
                        } catch (err) {
                            console.error(`‚ùå √âchec pour ${coinData.name}:`, err);
                            failedAssets.push(`${coinData.name}: ${err.message}`);
                            
                            // M√™me en cas d'erreur, attendre avant de continuer
                            if (i < this.state.assets.length - 1) {
                                console.log('‚è∏Ô∏è Pause apr√®s erreur...');
                                await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
                            }
                        }
                    }
                    
                    this.state.loading = false;
                    this.state.progressMessage = '';
                    this.render();
                    
                    const totalAssets = this.state.assets.length;
                    const successCount = successfulAssets.length;
                    const failCount = failedAssets.length;
                    
                    let message = `üìä R√©sultats: ${successCount}/${totalAssets} assets r√©cup√©r√©s\n\n`;
                    
                    if (successfulAssets.length > 0) {
                        message += `‚úÖ Succ√®s (${successCount}):\n${successfulAssets.join(', ')}\n`;
                    }
                    
                    if (failedAssets.length > 0) {
                        message += `\n‚ö†Ô∏è √âchecs (${failCount}):\n${failedAssets.map(f => f.split(':')[0]).join(', ')}\n`;
                        message += `\nüí° Pour les √©checs:\n`;
                        message += `- Certains assets r√©cents n'ont pas ${this.state.period}j d'historique\n`;
                        message += `- Essaie de r√©duire la p√©riode √† 7-14 jours\n`;
                        message += `- Ou supprime ces assets et relance`;
                    }
                    
                    if (successCount === 0) {
                        message = '‚ùå Aucun asset r√©cup√©r√© !\n\n';
                        message += 'Causes possibles:\n';
                        message += '- API CoinGecko temporairement indisponible\n';
                        message += '- Probl√®me de connexion internet\n';
                        message += '- Rate limit trop strict\n\n';
                        message += 'üí° Essaie:\n';
                        message += '- D\'attendre 5-10 minutes\n';
                        message += '- De r√©duire √† 2-3 assets\n';
                        message += '- De r√©duire la p√©riode √† 7 jours';
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    this.state.loading = false;
                    this.state.progressMessage = '';
                    this.render();
                    alert('‚ùå Erreur g√©n√©rale: ' + error.message);
                }
            }

            parsePriceData(text) {
                const lines = text.trim().split('\n');
                const prices = [];
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    if (line.includes(',')) {
                        const parts = line.split(',');
                        const price = parseFloat(parts[parts.length - 1]);
                        if (!isNaN(price)) prices.push(price);
                    } else {
                        const price = parseFloat(line);
                        if (!isNaN(price)) prices.push(price);
                    }
                }
                return prices;
            }

            calculateReturns(prices) {
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push((prices[i] - prices[i-1]) / prices[i-1]);
                }
                return returns;
            }

            calculateVolatility(returns) {
                const mean = returns.reduce((sum, r) => sum + r, 0) / returns.length;
                const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
                const dailyVol = Math.sqrt(variance);
                const annualizedVol = dailyVol * Math.sqrt(365) * 100;
                return annualizedVol;
            }

            calculatePortfolio() {
                try {
                    const assetData = [];
                    
                    for (let i = 0; i < this.state.assets.length; i++) {
                        const asset = this.state.assets[i];
                        const prices = this.parsePriceData(asset.data);
                        if (prices.length < 2) {
                            alert(`Donn√©es insuffisantes pour ${asset.name}. R√©cup√®re d'abord les donn√©es.`);
                            return;
                        }
                        const returns = this.calculateReturns(prices);
                        const volatility = this.calculateVolatility(returns);
                        
                        assetData.push({
                            name: CRYPTO_PAIRS[asset.selected].name,
                            volatility: volatility,
                            numPrices: prices.length
                        });
                    }

                    const avgVolatility = assetData.reduce((sum, a) => sum + a.volatility, 0) / assetData.length;
                    const totalInverseVol = assetData.reduce((sum, a) => sum + (1 / a.volatility), 0);
                    
                    assetData.forEach(asset => {
                        asset.weight = (1 / asset.volatility) / totalInverseVol;
                    });

                    this.state.betaResults = {
                        assets: assetData,
                        avgVolatility: avgVolatility,
                        numAssets: assetData.length
                    };

                    this.state.activeTab = 'calculator';
                    this.render();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }

            render() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-purple-900 p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl shadow-2xl border border-slate-700 p-6 mb-6">
                                <div class="flex items-center gap-3">
                                    ${Icons.Calculator()}
                                    <h1 class="text-3xl font-bold text-white">Beta Hedge Multi-Assets Mirror</h1>
                                </div>
                                <p class="text-slate-300 mt-2">Portfolio delta-neutral avec positions miroir sur 2 plateformes</p>
                            </div>
                            ${this.state.loading ? `
                                <div class="bg-blue-900/30 border border-blue-600 rounded-xl p-6 mb-6 text-center">
                                    <div class="animate-pulse">
                                        <div class="text-2xl mb-2">‚è≥</div>
                                        <p class="text-blue-300 font-semibold">${this.state.progressMessage}</p>
                                        <p class="text-sm text-slate-400 mt-2">Ne ferme pas cette page...</p>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex gap-2 mb-6">
                                <button id="tab-calculator" class="flex-1 py-3 px-6 rounded-lg font-semibold transition-all ${this.state.activeTab==='calculator'?'bg-blue-600 text-white':'bg-slate-700 text-slate-300'}">
                                    ${Icons.Calculator()} Calculateur
                                </button>
                                <button id="tab-beta" class="flex-1 py-3 px-6 rounded-lg font-semibold transition-all ${this.state.activeTab==='beta'?'bg-purple-600 text-white':'bg-slate-700 text-slate-300'}">
                                    ${Icons.BarChart()} Configuration Assets
                                </button>
                            </div>
                            ${this.state.activeTab==='calculator'?this.renderCalculator():this.renderBeta()}
                        </div>
                    </div>
                `;
            }

            renderCalculator() {
                if (!this.state.betaResults) {
                    return `
                        <div class="bg-slate-800/50 rounded-2xl p-8 border border-slate-700 text-center">
                            <p class="text-slate-300 text-lg mb-4">Configure d'abord tes assets dans l'onglet "Configuration Assets"</p>
                            <button id="go-to-beta" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">
                                Configurer les Assets
                            </button>
                        </div>
                    `;
                }

                const totalCap = this.state.capital;
                const positions = [];

                this.state.betaResults.assets.forEach((asset, i) => {
                    const size = totalCap * asset.weight / 2;
                    positions.push({
                        name: asset.name,
                        size: size,
                        volatility: asset.volatility,
                        weight: asset.weight,
                        direction1: i % 2 === 0 ? 'LONG' : 'SHORT',
                        direction2: i % 2 === 0 ? 'SHORT' : 'LONG'
                    });
                });

                return `
                    <div class="bg-slate-800/50 rounded-2xl p-8 border border-slate-700">
                        <div class="mb-6 bg-green-900/30 border border-green-600 rounded-lg p-4">
                            <p class="text-green-300 font-semibold">‚úì Portfolio: ${this.state.betaResults.numAssets} assets | Vol moyenne: ${this.state.betaResults.avgVolatility.toFixed(2)}%</p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Capital Total (USD)</label>
                                <input id="capital" type="number" value="${this.state.capital}" class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 border border-slate-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Leverage</label>
                                <input id="leverage" type="number" value="${this.state.leverage}" min="1" max="10" step="0.5" class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 border border-slate-600">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-gradient-to-br from-green-900/20 to-slate-800/20 border border-green-700/50 rounded-xl p-6">
                                <h2 class="text-2xl font-bold text-green-400 mb-4">üìà Plateforme 1</h2>
                                <div class="space-y-3">
                                    ${positions.map(pos => `
                                        <div class="bg-slate-700/50 rounded-lg p-4">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm font-semibold ${pos.direction1==='LONG'?'text-green-400':'text-red-400'}">${pos.direction1} ${pos.name}</span>
                                                <span class="text-xs text-slate-400">Vol: ${pos.volatility.toFixed(1)}%</span>
                                            </div>
                                            <p class="text-2xl font-bold text-white">$${(pos.size * this.state.leverage).toFixed(2)}</p>
                                            <div class="flex justify-between mt-1">
                                                <p class="text-xs text-slate-500">Capital: $${pos.size.toFixed(2)}</p>
                                                <p class="text-xs text-slate-500">Poids: ${(pos.weight*100).toFixed(1)}%</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-4 pt-4 border-t border-slate-700">
                                    <p class="text-sm text-slate-400">Capital total</p>
                                    <p class="text-lg font-semibold text-white">$${(totalCap/2).toFixed(2)}</p>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-red-900/20 to-slate-800/20 border border-red-700/50 rounded-xl p-6">
                                <h2 class="text-2xl font-bold text-red-400 mb-4">üìâ Plateforme 2</h2>
                                <div class="space-y-3">
                                    ${positions.map(pos => `
                                        <div class="bg-slate-700/50 rounded-lg p-4">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm font-semibold ${pos.direction2==='LONG'?'text-green-400':'text-red-400'}">${pos.direction2} ${pos.name}</span>
                                                <span class="text-xs text-slate-400">Vol: ${pos.volatility.toFixed(1)}%</span>
                                            </div>
                                            <p class="text-2xl font-bold text-white">$${(pos.size * this.state.leverage).toFixed(2)}</p>
                                            <div class="flex justify-between mt-1">
                                                <p class="text-xs text-slate-500">Capital: $${pos.size.toFixed(2)}</p>
                                                <p class="text-xs text-slate-500">Poids: ${(pos.weight*100).toFixed(1)}%</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-4 pt-4 border-t border-slate-700">
                                    <p class="text-sm text-slate-400">Capital total</p>
                                    <p class="text-lg font-semibold text-white">$${(totalCap/2).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderBeta() {
                const cryptoOptions = Object.entries(CRYPTO_PAIRS)
                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                    .map(([id, data]) => `<option value="${id}">${data.name}</option>`)
                    .join('');

                return `
                    <div class="bg-slate-800/50 rounded-2xl p-8 border border-slate-700">
                        <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-600 rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-white mb-4">${Icons.Download()} Configuration des Assets</h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-slate-300 mb-2">P√©riode (jours)</label>
                                <input id="period" type="number" value="${this.state.period}" min="7" max="365" class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 border border-slate-600">
                            </div>

                            ${this.state.assets.map((asset, i) => `
                                <div class="mb-4 p-4 bg-slate-700/50 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                                Asset ${i+1} 
                                                <span class="text-xs ${i%2===0?'text-green-400':'text-red-400'} ml-2">
                                                    (P1: ${i%2===0?'LONG':'SHORT'} | P2: ${i%2===0?'SHORT':'LONG'})
                                                </span>
                                            </label>
                                            <select id="asset-select-${i}" class="w-full bg-slate-600 text-white rounded-lg px-4 py-2 border border-slate-500">
                                                ${cryptoOptions}
                                            </select>
                                        </div>
                                        ${i >= 2 ? `<button data-remove="${i}" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg">${Icons.X()}</button>` : ''}
                                    </div>
                                </div>
                            `).join('')}

                            <button id="add-asset" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 rounded-lg mb-4 flex items-center justify-center gap-2">
                                ${Icons.Plus()} Ajouter un Asset
                            </button>

                            <button id="fetch-data" ${this.state.loading?'disabled':''} class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-semibold py-3 rounded-lg mb-4 disabled:opacity-50">
                                ${this.state.loading?'‚è≥ Chargement...':`${Icons.Download()} R√©cup√©rer tous les Assets`}
                            </button>

                            <button id="calculate" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg">
                                Calculer et Afficher les Positions
                            </button>
                        </div>

                        <div class="bg-yellow-900/20 border border-yellow-600 rounded-lg p-6 mb-4">
                            <h3 class="text-lg font-bold text-yellow-400 mb-3">‚ö†Ô∏è Syst√®me ANTI-RATE-LIMIT Intelligent</h3>
                            <ul class="space-y-2 text-sm text-slate-300">
                                <li>‚Ä¢ <strong>6 secondes entre chaque asset</strong></li>
                                <li>‚Ä¢ <strong>30 SECONDES de SUPER PAUSE tous les 4 assets</strong> üîÑ</li>
                                <li>‚Ä¢ Exemple: Asset 4 ‚Üí SUPER PAUSE 30s ‚Üí Asset 5</li>
                                <li>‚Ä¢ Ceci permet de "reset" le rate limit de l'API</li>
                                <li>‚Ä¢ C'est TR√àS LENT mais √ßa marche √† 100% !</li>
                            </ul>
                        </div>

                        <div class="bg-blue-900/20 border border-blue-600 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-blue-400 mb-3">‚è±Ô∏è Temps estim√© R√âEL</h3>
                            <ul class="space-y-2 text-sm text-slate-300">
                                <li>‚Ä¢ <strong>1-4 assets:</strong> ~24 secondes (6s √ó 4)</li>
                                <li>‚Ä¢ <strong>5-8 assets:</strong> ~1m12s (30s pause + 24s)</li>
                                <li>‚Ä¢ <strong>9-10 assets:</strong> ~2m18s (2√ó 30s pauses + assets)</li>
                                <li>‚Ä¢ üí° <strong>Va prendre un caf√© pendant le chargement ‚òï</strong></li>
                                <li>‚Ä¢ üéØ Mais tu auras tes 10 assets sans erreur !</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            attachEvents() {
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'tab-calculator') {
                        this.state.activeTab = 'calculator';
                        this.render();
                    }
                    if (e.target.id === 'tab-beta') {
                        this.state.activeTab = 'beta';
                        this.render();
                    }
                    if (e.target.id === 'add-asset') {
                        this.addAsset();
                    }
                    if (e.target.dataset.remove !== undefined) {
                        this.removeAsset(parseInt(e.target.dataset.remove));
                    }
                    if (e.target.id === 'fetch-data') {
                        this.fetchAllAssets();
                    }
                    if (e.target.id === 'calculate') {
                        this.calculatePortfolio();
                    }
                    if (e.target.id === 'go-to-beta') {
                        this.state.activeTab = 'beta';
                        this.render();
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.id.startsWith('asset-select-')) {
                        const index = parseInt(e.target.id.split('-')[2]);
                        this.state.assets[index].selected = e.target.value;
                        this.state.assets[index].name = CRYPTO_PAIRS[e.target.value].name;
                    }
                });

                document.addEventListener('input', (e) => {
                    if (e.target.id === 'capital') {
                        this.state.capital = Number(e.target.value);
                        this.render();
                    }
                    if (e.target.id === 'leverage') {
                        this.state.leverage = Number(e.target.value);
                        this.render();
                    }
                    if (e.target.id === 'period') {
                        this.state.period = Number(e.target.value);
                    }
                });
            }
        }

        new BetaHedgeCalculator();
    </script>
</body>
</html>
